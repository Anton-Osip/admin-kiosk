________________


🧩 Документация для фронтенда — Partner Dashboard & Kiosk API
________________


🎯 Общая логика
Партнёр (роль Partner) видит только свои магазины, свои киоски и свои заказы. Аутентификация — через сессии Redis (не JWT).


________________


📦 Основные сущности
Сущность
	Назначение
	Orders
	Заказы, созданные киосками (включают имя клиента, email, фото и статус печати).
	Kiosks
	Физические устройства, принадлежащие магазину партнёра.
	FreeRoundCodes
	4-значные коды для бесплатной генерации (offline-доступ, либо компенсация при ошибках).
	KioskErrors
	История ошибок киоска.
	ActivityLogs
	Лог всех действий: выдача кода, смена языка, отметка печати и т.п.
	

________________


🧭 1. Partner Dashboard API
Все эндпоинты доступны только авторизованным пользователям с ролью Partner. Путь всегда начинается с /partner/....


________________


📂 1.1 Заказы (Partner Orders)
Метод
	Путь
	Описание
	GET
	/partner/orders/new
	Список новых заказов: нераспечатанные за последние 3 часа + только что распечатанные (15 мин). Для экрана “Новые заказы”.
	GET
	/partner/orders
	Полный список заказов за последние 30 дней. Поддерживает фильтры: статус, дата, номер киоска, имя клиента и т.д.
	GET
	/partner/orders/:id
	Подробности конкретного заказа.
	POST
	/partner/orders/:id/mark
	Пометить заказ как printed или not_printed. Обновляет поле printedAt и пишет лог.
	GET
	/partner/orders/daily-counters
	Возвращает статистику за день: { all, printed }. Для дашборда.
	

🧾 Данные, которые возвращаются:


{


  "id": "uuid",


  "customerName": "John Doe",


  "customerEmail": "john@example.com",


  "customerPhone": "+1234567890",


  "status": "printed",


  "imageUrl": "https://s3.amazonaws.com/.../image.jpg",


  "printedAt": "2025-10-15T12:30:00Z",


  "kiosk": { "id": "...", "name": "Kiosk #1" },


  "createdAt": "2025-10-15T09:00:00Z"


}


________________


🖥️ 1.2 Киоски (Partner Kiosks)
Метод
	Путь
	Описание
	GET
	/partner/kiosks
	Список всех киосков партнёра (по его магазинам).
	GET
	/partner/kiosks/:id
	Детали киоска (имя, локация, статус, язык, ошибки).
	POST
	/partner/kiosks/:id/status
	Включить / выключить киоск (active, inactive, error).
	POST
	/partner/kiosks/:id/language
	Сменить язык интерфейса киоска (en, fr, es, he и т.д.).
	POST
	/partner/kiosks/:id/code
	Сгенерировать 4-значный код для бесплатного “раунда”. Тип кода (cash или error) определяется автоматически.
	GET
	/partner/kiosks/:id/errors?limit=3
	Получить последние ошибки киоска (по умолчанию 3).
	POST
	/partner/kiosks/:id/errors/clear
	Сбросить ошибку: статус → active, lastErrorCode очищается, логируется событие.
	

📘 Типовой ответ при получении киосков:


[


  {


    "id": "uuid",


    "name": "Kiosk #1",


    "location": "Tel Aviv Mall",


    "status": "active",


    "lastErrorCode": null,


    "settings": { "defaultLanguage": "en" }


  }


]


________________


🎟️ 1.3 Бесплатные коды (Free Round Codes)
Метод
	Путь
	Описание
	POST
	/partner/kiosks/:id/code
	Создать код для данного киоска. Возвращает 4-значный код.
	POST
	/kiosk/:id/code/redeem
	(Со стороны киоска) — погасить код. Проверяется валидность, если type = 'cash' → фиксируется в балансе.
	

🧩 Пример:


// POST /partner/kiosks/123/code


{


  "code": "4821",


  "type": "error",


  "issuedAt": "2025-10-15T12:00:00Z"


}


________________


⚠️ 1.4 Ошибки киосков (Kiosk Errors)
Метод
	Путь
	Описание
	POST
	/kiosk/:id/errors
	(Киоск → сервер) сообщает о новой ошибке { code, message }. Создаёт запись и ставит статус error.
	GET
	/partner/kiosks/:id/errors?limit=3
	(Партнёр → панель) показывает последние ошибки.
	POST
	/partner/kiosks/:id/errors/clear
	Сбрасывает ошибку и возвращает киоск в active.
	

🧾 Пример отчёта об ошибке:


{


  "code": "B2",


  "message": "Paper jam detected"


}


________________


📊 1.5 Логи активности (Activity Logs)
Система автоматически пишет логи для всех действий:


Событие
	Когда пишется
	ORDER_MARK_PRINTED
	Партнёр отметил заказ как напечатанный
	ORDER_MARK_NOT_PRINTED
	Заказ отмечен как неудавшийся
	KIOSK_CODE_ISSUED
	Партнёр выдал бесплатный код
	KIOSK_LANGUAGE_SET
	Изменён язык интерфейса
	KIOSK_ERROR_REPORTED
	Киоск отправил ошибку
	KIOSK_ERROR_CLEARED
	Ошибка сброшена
	KIOSK_STATUS_CHANGED
	Статус киоска изменён вручную
	

Фронтенду логи напрямую не нужны, но используются для аналитики и отладки.


________________


🤖 2. Kiosk API (со стороны устройства)
Метод
	Путь
	Описание
	POST
	/kiosk/:id/code/redeem
	Проверяет код, помечает как использованный (consumedAt=now()), возвращает { ok: true }.
	POST
	/kiosk/:id/errors
	Сообщает об ошибке (см. выше).
	POST
	/kiosk/:id/heartbeat
	(опционально) Пинг киоска, чтобы обновить lastActiveAt.
	

________________


🧹 3. Очистка данных (в фоне)
Ежедневно (через cron):


* Удаляются заказы старше 30 дней.
* Удаляются коды FreeRoundCodes старше 60 дней.
* Изображения из S3, к которым больше нет заказов, тоже удаляются.
* Старые ошибки киосков — по желанию, тоже через 60 дней.


________________


🧩 4. Примечания
* Онлайн-оплата не использует коды (FreeRoundCodes) — киоск просто активируется после оплаты.
* Коды нужны только для ручных выдач и ошибочных ситуаций.
* Все фильтры данных на фронте должны учитывать userId → shops → kiosks.


________________




Хочешь — я сделаю вторую часть этого документа в виде таблицы “📋 API для фронтенда” (эндпоинт → метод → входные параметры → пример ответа), чтобы твой фронтендер мог просто вставить в Postman и проверять вызовы?